<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>FlexBase - Nova Aplicação</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="../../assets/css/db.css">
	<link rel="stylesheet" href="../../assets/css/home.css">
</head>
<body>
	<!-- Floating Glass Navbar -->
	<nav class="floating-navbar">
		<div class="navbar-content">
			<div class="navbar-brand">
				<h1 class="logo"><img src="../../assets/img/logo.png" alt="FlexBase" width="30px"></h1>
			</div>
			<div class="navbar-actions">
				<a href="../home/index.html" class="btn-glass btn-secondary">
					<i class="bi bi-house"></i>
					<span>Homepage</span>
				</a>
				<button class="btn-glass btn-secondary">
					<i class="bi bi-credit-card"></i>
					<span>Planos</span>
				</button>
				<button class="btn-glass btn-secondary">
					<i class="bi bi-person-circle"></i>
					<span>Meu Perfil</span>
				</button>
				<button id="themeToggle" class="btn-glass btn-theme">
					<i class="bi bi-sun"></i>
				</button>
				<button id="logoutBtn" class="btn-glass" style="background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.3);">
					<i class="bi bi-box-arrow-right"></i>
					<span>Logout</span>
				</button>
			</div>
		</div>
	</nav>

	<main class="main-container" style="height: 100vh;">
		<div class="canvas-grid"></div>
		<div class="main-content d-flex justify-content-center align-items-center" style="height: 80vh;">
			<div class="auth-card" style="max-width: 400px; width: 100%;">
				<div class="auth-logo text-center mb-4">
					<img src="../../assets/img/logo.png" alt="FlexBase Logo" width="50">
					<h2 class="mt-2">Nova Aplicação</h2>
					<p class="text-white-50">Crie uma nova aplicação para seu projeto</p>
				</div>
				<div id="alertContainer"></div>
				<form id="novaAplicacaoForm">
					<div class="form-floating mb-3">
						<input type="text" class="form-control" id="nomeAplicacao" placeholder="Nome da aplicação" required>
						<label for="nomeAplicacao"><i class="bi bi-box me-2"></i>Nome da aplicação</label>
					</div>
					<div class="form-floating mb-3">
						<textarea class="form-control" id="descricaoAplicacao" placeholder="Descrição" style="height: 100px" required></textarea>
						<label for="descricaoAplicacao"><i class="bi bi-card-text me-2"></i>Descrição</label>
					</div>
					<button type="submit" class="btn btn-primary w-100">
						<span class="btn-text">Próximo</span>
						<div class="loading-spinner ms-2" style="display:none;"></div>
					</button>
				</form>
			</div>
		</div>
	</main>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="../../assets/js/config.js"></script>
	<script>
	// Animação, troca de tela e cadastro da aplicação
	document.addEventListener('DOMContentLoaded', function() {
		let appData = {};
		const form = document.getElementById('novaAplicacaoForm');
		const btn = form.querySelector('button');
		const btnText = btn.querySelector('.btn-text');
		const spinner = btn.querySelector('.loading-spinner');
		const alertContainer = document.getElementById('alertContainer');
		const authCard = document.querySelector('.auth-card');

		form.addEventListener('submit', function(e) {
			e.preventDefault();
			appData.nome = document.getElementById('nomeAplicacao').value;
			appData.descricao = document.getElementById('descricaoAplicacao').value;

			authCard.classList.add('animate__animated', 'animate__fadeOutLeft');
			setTimeout(() => {
				authCard.innerHTML = `
					<div class='auth-logo text-center mb-4'>
						<img src='../../assets/img/logo.png' alt='FlexBase Logo' width='50'>
						<h2 class='mt-2'>Banco de Dados</h2>
						<p class='text-white-50'>Escolha um nome para o banco de dados da aplicação <strong>${appData.nome}</strong></p>
					</div>
					<form id='dbForm'>
						<div class='form-floating mb-3'>
							<input type='text' class='form-control' id='nomeBanco' placeholder='Nome do banco de dados' required autofocus>
							<label for='nomeBanco'><i class='bi bi-database me-2'></i>Nome do banco de dados</label>
						</div>
						<button type='submit' class='btn btn-success w-100'>
							<span class='btn-text'>Finalizar</span>
							<div class='loading-spinner ms-2' style='display:none;'></div>
						</button>
					</form>
					<div id='alertContainer'></div>
				`;
				authCard.classList.remove('animate__fadeOutLeft');
				authCard.classList.add('animate__fadeInRight');

				const dbForm = document.getElementById('dbForm');
				const dbBtn = dbForm.querySelector('button');
				const dbBtnText = dbBtn.querySelector('.btn-text');
				const dbSpinner = dbBtn.querySelector('.loading-spinner');
				const dbAlert = document.getElementById('alertContainer');
				dbForm.addEventListener('submit', async function(ev) {
					ev.preventDefault();
					appData.banco = document.getElementById('nomeBanco').value;
					dbBtn.disabled = true;
					dbBtnText.textContent = 'Finalizando...';
					dbSpinner.style.display = 'inline-block';
					dbAlert.innerHTML = '';

					// Monta o body para o endpoint
					const body = {
						nome: appData.nome,
						readme: appData.descricao,
						nomeBanco: appData.banco,
						schemaBanco: { tabelas: [] }
					};
					// Recupera token do localStorage
					const token = localStorage.getItem('token');
					try {
						const response = await fetch('http://localhost:80/api/aplicacoes', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Authorization': 'Bearer ' + token
							},
							body: JSON.stringify(body)
						});
						const result = await response.json();
						dbBtn.disabled = false;
						dbBtnText.textContent = 'Finalizar';
						dbSpinner.style.display = 'none';
						if (response.ok && result.success) {
							dbAlert.innerHTML = `<div class='alert alert-success mt-3'>Aplicação <strong>${appData.nome}</strong> criada com sucesso!</div>`;
							setTimeout(() => {
								window.location.href = '../home/index.html';
							}, 1500);
						} else {
							dbAlert.innerHTML = `<div class='alert alert-danger mt-3'>Erro ao criar aplicação: ${result.message || 'Verifique os dados e tente novamente.'}</div>`;
						}
					} catch (err) {
						dbBtn.disabled = false;
						dbBtnText.textContent = 'Finalizar';
						dbSpinner.style.display = 'none';
						dbAlert.innerHTML = `<div class='alert alert-danger mt-3'>Erro de conexão. Tente novamente.</div>`;
					}
				});
			}, 600);
		});
	});
	</script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</body>
</html>
